<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebAR — Miniverso Taza</title>

  <!-- A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>

  <!-- MindAR -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.7/dist/mindar-image-aframe.prod.js"></script>

  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    #startScreen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #1b1030 0, #050509 60%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      z-index: 20;
      text-align: center;
      color: #fff;
    }

    #startScreen h2 {
      margin: 0 0 0.25rem 0;
      font-size: 1.4rem;
      letter-spacing: 0.03em;
    }

    #startScreen p {
      margin: 0;
      max-width: 260px;
      opacity: 0.85;
      font-size: 0.95rem;
    }

    #startButton {
      margin-top: 1.8rem;
      background: #f9a825;
      color: #111;
      font-weight: 600;
      padding: 12px 22px;
      border-radius: 999px;
      font-size: 1rem;
      border: none;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }

    #hint {
      position: fixed;
      bottom: 10px;
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      font-size: 0.8rem;
      z-index: 10;
      opacity: 0.8;
    }

    .glow {
      animation: pulse 2s infinite ease-in-out;
    }

    @keyframes pulse {
      0% { opacity: 0.7; }
      50% { opacity: 1; }
      100% { opacity: 0.7; }
    }

    /* Fallback (sin cámara / sin AR) */
    #fallback {
      position: fixed;
      inset: 0;
      display: none; /* se muestra solo si AR falla */
      justify-content: center;
      align-items: center;
      background: radial-gradient(circle at top, #1b1030 0, #050509 60%);
      padding: 1.5rem;
      color: #fff;
      z-index: 5;
    }

    .fallback-card {
      width: 100%;
      max-width: 360px;
      background: rgba(8, 8, 16, 0.9);
      border-radius: 24px;
      padding: 1.75rem 1.5rem 1.5rem;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      border: 1px solid rgba(255,255,255,0.05);
    }

    .fallback-card h3 {
      margin: 0 0 0.35rem 0;
      font-size: 1.1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      opacity: 0.9;
    }

    .fallback-card h2 {
      margin: 0 0 0.6rem 0;
      font-size: 1.3rem;
    }

    .fallback-card p {
      margin: 0 0 1rem 0;
      font-size: 0.9rem;
      opacity: 0.85;
    }

    .fallback-highlight {
      margin: 0 0 0.75rem 0;
      font-size: 0.95rem;
      color: #ffecb3;
    }

    .fallback-footer {
      margin-top: 1.1rem;
      font-size: 0.8rem;
      opacity: 0.7;
    }

    #fallbackPortal {
      margin-top: 0.75rem;
      width: 100%;
      background: #f9a825;
      color: #111;
      font-weight: 600;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
    }

    a-scene {
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>

<body>

  <!-- Pantalla inicial -->
  <div id="startScreen">
    <h2>WebAR · Miniverso Taza</h2>
    <p>Apunta tu cámara a la taza. La constelación se revelará cuando el marcador sea detectado.</p>
    <button id="startButton">Iniciar WebAR</button>
  </div>

  <div id="hint">Permite acceso a la cámara</div>

  <!-- Fallback sin cámara / sin AR -->
  <div id="fallback">
    <div class="fallback-card">
      <h3>Miniverso Taza</h3>
      <h2>Tu constelación está lista</h2>
      <p class="fallback-highlight">
        Si tu cámara no se activó, no pasa nada. Esta es la pista que le corresponde a tu taza.
      </p>
      <p>
        28 de diciembre. Una fecha que se abre como una grieta luminosa:
        el día en que #GatoEncerrado salió del escenario para habitar tu mesa.
      </p>
      <p>
        Guarda esta taza como un recordatorio de que a veces el boleto no está en el papel, sino en el objeto
        que decides sostener entre las manos.
      </p>
      <button id="fallbackPortal">Entrar al portal</button>
      <div class="fallback-footer">
        Si en otro dispositivo se activa la cámara, verás la constelación flotando sobre la taza.
      </div>
    </div>
  </div>

  <!-- ESCENA AR -->
  <a-scene
    mindar-image="imageTargetSrc: ./taza.mind; filterMinCF: 0.0001; warmupTolerance: 5; autoStart: false"
    color-management="true"
    renderer="precision: mediump; antialias: true; physicallyCorrectLights: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    embedded
  >
    <a-camera
      position="0 0 0"
      look-controls="enabled: false"
      cursor="rayOrigin: mouse"
      raycaster="objects: .clickable"
    ></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <!-- Constelación -->
      <a-sphere radius="0.015" position="0 0 0.1" color="#fff" class="glow"></a-sphere>
      <a-sphere radius="0.012" position="0.05 0.04 0.1" color="#fff" class="glow"></a-sphere>
      <a-sphere radius="0.01" position="-0.04 0.03 0.1" color="#fff" class="glow"></a-sphere>
      <a-sphere radius="0.011" position="0.03 -0.03 0.1" color="#fff" class="glow"></a-sphere>
      <a-sphere radius="0.01" position="-0.03 -0.03 0.1" color="#fff" class="glow"></a-sphere>

      <a-entity line="start: 0 0 0.1; end: 0.05 0.04 0.1; color: #fff"></a-entity>
      <a-entity line="start: 0 0 0.1; end: -0.04 0.03 0.1; color: #fff"></a-entity>
      <a-entity line="start: 0.05 0.04 0.1; end: 0.03 -0.03 0.1; color: #fff"></a-entity>
      <a-entity line="start: -0.04 0.03 0.1; end: -0.03 -0.03 0.1; color: #fff"></a-entity>

      <!-- Fecha -->
      <a-entity
        position="0 -0.15 0.1"
        text="value: 28 de diciembre; align: center; color: #FFD54F; width: 1.2;"
      ></a-entity>

      <!-- Botón portal (en AR) -->
      <a-plane
        id="portalButton"
        position="0 -0.26 0.1"
        width="0.75"
        height="0.18"
        color="#FFD54F"
        opacity="0.95"
        class="clickable"
      >
        <a-entity
          position="0 0 0.02"
          text="value: Entrar al portal; align: center; color: #111; width: 1.1;"
        ></a-entity>
      </a-plane>
    </a-entity>
  </a-scene>

  <script>
    const startScreen = document.getElementById("startScreen");
    const startButton = document.getElementById("startButton");
    const hint = document.getElementById("hint");
    const fallback = document.getElementById("fallback");
    const fallbackPortal = document.getElementById("fallbackPortal");
    const portalPlane = document.getElementById("portalButton");
    const sceneEl = document.querySelector("a-scene");
    const targetEntity = document.querySelector("[mindar-image-target]");
    const portalUrl = "https://esungatoencerrado.ai";
    let arSystem = null;
    let hasStarted = false;
    let fallbackTimeoutId;
    let fallbackShown = false;

    const openPortal = () => {
      window.location.href = portalUrl;
    };

    const showFallback = (message = "") => {
      if (fallbackShown) return;
      fallbackShown = true;
      hint.textContent = message;
      if (sceneEl) sceneEl.style.display = "none";
      fallback.style.display = "flex";
    };

    const ensureSceneLoaded = () => {
      if (!sceneEl) return Promise.resolve();
      return sceneEl.hasLoaded
        ? Promise.resolve()
        : new Promise((resolve) => {
            sceneEl.addEventListener("loaded", resolve, { once: true });
          });
    };

    const getMindARSystem = () => {
      if (arSystem) return arSystem;
      if (!sceneEl) return null;
      const systems = sceneEl.systems || {};
      const components = sceneEl.components || {};
      arSystem =
        systems["mindar-image-system"] ||
        systems["mindar-image"] ||
        components["mindar-image"];
      return arSystem;
    };

    const checkVideoFeed = () => {
      const video = document.querySelector("video");
      const noVideo =
        !video ||
        video.readyState < 2 ||
        video.videoWidth === 0 ||
        video.videoHeight === 0;
      if (noVideo) {
        showFallback("No pudimos usar la cámara de este dispositivo.");
      } else if (!fallbackShown) {
        hint.textContent = "Apunta la cámara a la taza";
      }
    };

    const startMindAR = async () => {
      if (hasStarted || !sceneEl) return;
      hint.textContent = "Preparando constelación...";
      startScreen.style.display = "none";

      await ensureSceneLoaded();
      const system = getMindARSystem();

      if (!system || typeof system.start !== "function") {
        console.warn("MindAR no está disponible en esta escena.");
        showFallback("Este navegador no soporta la activación WebAR.");
        return;
      }

      try {
        await system.start();
        hasStarted = true;
        hint.textContent = "Apunta la cámara a la taza";
        if (fallbackTimeoutId) clearTimeout(fallbackTimeoutId);
        fallbackTimeoutId = window.setTimeout(checkVideoFeed, 6000);
      } catch (error) {
        console.error("Error al iniciar MindAR:", error);
        showFallback("No pudimos iniciar la cámara. Intenta con otro dispositivo.");
      }
    };

    // Comportamiento del botón de inicio
    startButton.addEventListener("click", () => {
      startMindAR();
    });

    if (sceneEl) {
      sceneEl.addEventListener("arReady", () => {
        if (!fallbackShown) hint.textContent = "Apunta la cámara a la taza";
      });

      sceneEl.addEventListener("arError", () => {
        showFallback("Este dispositivo no es compatible con la experiencia AR.");
      });
    }

    if (targetEntity) {
      targetEntity.addEventListener("targetFound", () => {
        if (!fallbackShown) hint.textContent = "Constelación detectada · mantén la taza enfocada";
      });
      targetEntity.addEventListener("targetLost", () => {
        if (!fallbackShown) hint.textContent = "Apunta la cámara a la taza";
      });
    }

    // Portal en AR y fallback
    if (portalPlane) {
      portalPlane.addEventListener("click", openPortal);
    }
    if (fallbackPortal) {
      fallbackPortal.addEventListener("click", openPortal);
    }
  </script>
</body>
</html>
